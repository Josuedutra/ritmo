// Prisma Schema for RITMO MVP v1.1
// https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================================================
// ENUMS
// ============================================================================

enum BusinessStatus {
  draft
  sent
  negotiation
  won
  lost
}

enum RitmoStage {
  idle
  fup_d1
  fup_d3
  fup_d7
  fup_d14
  completed
  paused
  stopped
}

enum CadenceEventStatus {
  scheduled
  claimed
  sent
  completed
  skipped
  cancelled
  deferred
  failed
}

enum CallPriority {
  HIGH
  LOW
}

enum UserRole {
  admin
  member
}

enum TaskStatus {
  pending
  completed
  skipped
}

enum EmailLogStatus {
  queued
  sent
  delivered
  bounced
  failed
}

enum SuppressionReason {
  opt_out
  bounce
  complaint
}

enum SubscriptionStatus {
  active
  past_due
  cancelled
  trialing
}

enum IngestStatus {
  pending
  processed
  failed
  unmatched
}

// ============================================================================
// ORGANIZATION & USERS
// ============================================================================

model Organization {
  id                  String   @id @default(uuid())
  shortId             String   @unique @default(cuid()) @map("short_id") // For BCC address: bcc+{shortId}+{quotePublicId}@inbound.ritmo.app
  name                String
  slug                String   @unique
  timezone            String   @default("Europe/Lisbon")
  valueThreshold      Decimal  @default(1000.00) @map("value_threshold") @db.Decimal(10, 2)
  sendWindowStart     String   @default("09:00") @map("send_window_start")
  sendWindowEnd       String   @default("18:00") @map("send_window_end")
  emailCooldownHours  Int      @default(48) @map("email_cooldown_hours")
  bccAddress          String?  @unique @map("bcc_address")
  
  // SMTP settings (optional, per-org)
  smtpHost            String?  @map("smtp_host")
  smtpPort            Int?     @map("smtp_port")
  smtpUser            String?  @map("smtp_user")
  smtpPassEncrypted   String?  @map("smtp_pass_encrypted")
  smtpFrom            String?  @map("smtp_from")

  // Onboarding state (JSON with completed steps)
  onboardingCompleted Boolean  @default(false) @map("onboarding_completed")
  onboardingState     Json?    @map("onboarding_state") // { templates: bool, smtp: bool, bcc: bool, firstQuote: bool }

  createdAt           DateTime @default(now()) @map("created_at")
  updatedAt           DateTime @updatedAt @map("updated_at")

  // Relations
  users               User[]
  contacts            Contact[]
  quotes              Quote[]
  templates           Template[]
  suppressions        SuppressionGlobal[]
  subscription        Subscription?
  usageCounters       UsageCounter[]
  attachments         Attachment[]
  inboundIngestions   InboundIngestion[]
  cadenceEvents       CadenceEvent[]
  tasks               Task[]
  emailLogs           EmailLog[]

  @@map("organizations")
}

model User {
  id              String    @id @default(uuid())
  organizationId  String    @map("organization_id")
  email           String
  name            String?
  passwordHash    String?   @map("password_hash")
  role            UserRole  @default(member)
  emailVerified   DateTime? @map("email_verified")
  image           String?

  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")

  // Relations
  organization    Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  quotesCreated   Quote[]      @relation("CreatedBy")
  tasksAssigned   Task[]       @relation("AssignedTo")
  attachments     Attachment[] @relation("UploadedBy")
  accounts        Account[]
  sessions        Session[]

  @@unique([organizationId, email])
  @@map("users")
}

// ============================================================================
// NEXTAUTH MODELS
// ============================================================================

model Account {
  id                String  @id @default(uuid())
  userId            String  @map("user_id")
  type              String
  provider          String
  providerAccountId String  @map("provider_account_id")
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@map("accounts")
}

model Session {
  id           String   @id @default(uuid())
  sessionToken String   @unique @map("session_token")
  userId       String   @map("user_id")
  expires      DateTime

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("sessions")
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
  @@map("verification_tokens")
}

// ============================================================================
// CONTACTS
// ============================================================================

model Contact {
  id              String   @id @default(uuid())
  organizationId  String   @map("organization_id")
  email           String?  // NULLABLE: contact may not have email (v1.1)
  name            String?
  company         String?
  phone           String?
  notes           String?

  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  // Relations
  organization    Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  quotes          Quote[]

  // Partial unique index: unique only where email is not null
  // Note: This needs to be created via raw SQL migration
  @@index([organizationId, email])
  @@map("contacts")
}

// ============================================================================
// QUOTES (ORÃ‡AMENTOS)
// ============================================================================

model Quote {
  id              String         @id @default(uuid())
  publicId        String         @unique @default(cuid()) @map("public_id") // For BCC address, not exposed internal UUID
  organizationId  String         @map("organization_id")
  contactId       String?        @map("contact_id")
  cadenceRunId    Int            @default(0) @map("cadence_run_id")

  reference       String?
  title           String
  serviceType     String?        @map("service_type")
  value           Decimal?       @db.Decimal(12, 2)
  currency        String         @default("EUR")
  
  // v1.1: Separated states
  businessStatus  BusinessStatus @default(draft) @map("business_status")
  ritmoStage      RitmoStage     @default(idle) @map("ritmo_stage")

  sentAt          DateTime?      @map("sent_at")
  firstSentAt     DateTime?      @map("first_sent_at") // Immutable after first set, for billing
  validUntil      DateTime?      @map("valid_until")
  
  proposalLink    String?        @map("proposal_link")
  proposalFileId  String?        @map("proposal_file_id")
  
  notes           String?
  lastActivityAt  DateTime?      @map("last_activity_at")
  createdById     String?        @map("created_by")

  createdAt       DateTime       @default(now()) @map("created_at")
  updatedAt       DateTime       @updatedAt @map("updated_at")

  // Relations
  organization    Organization   @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  contact         Contact?       @relation(fields: [contactId], references: [id])
  createdBy       User?          @relation("CreatedBy", fields: [createdById], references: [id])
  proposalFile    Attachment?    @relation("ProposalFile", fields: [proposalFileId], references: [id])
  cadenceEvents   CadenceEvent[]
  tasks           Task[]
  emailLogs       EmailLog[]
  inboundIngestions InboundIngestion[]

  @@index([organizationId, businessStatus])
  @@index([organizationId, ritmoStage])
  @@index([organizationId, firstSentAt])
  @@map("quotes")
}

// ============================================================================
// CADENCE EVENTS
// ============================================================================

model CadenceEvent {
  id              String              @id @default(uuid())
  organizationId  String              @map("organization_id")
  quoteId         String              @map("quote_id")
  cadenceRunId    Int                 @map("cadence_run_id")
  eventType       String              @map("event_type") // email_d1 | email_d3 | call_d7 | email_d14
  scheduledFor    DateTime            @map("scheduled_for")
  status          CadenceEventStatus  @default(scheduled)
  priority        CallPriority?       // Only for call_d7
  
  // v1.1: Reason tracking
  skipReason      String?             @map("skip_reason")   // no_email | suppressed | manual
  cancelReason    String?             @map("cancel_reason") // status_changed | resent | manual
  
  // v1.1: Transactional claim fields
  claimedAt       DateTime?           @map("claimed_at")
  claimedBy       String?             @map("claimed_by")    // Worker ID
  processedAt     DateTime?           @map("processed_at")
  errorMessage    String?             @map("error_message")

  createdAt       DateTime            @default(now()) @map("created_at")

  // Relations
  organization    Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  quote           Quote        @relation(fields: [quoteId], references: [id], onDelete: Cascade)
  tasks           Task[]
  emailLogs       EmailLog[]

  @@unique([quoteId, cadenceRunId, eventType])
  @@index([organizationId, status, scheduledFor])
  @@index([status, scheduledFor, claimedAt])
  @@map("cadence_events")
}

// ============================================================================
// TASKS
// ============================================================================

model Task {
  id              String      @id @default(uuid())
  organizationId  String      @map("organization_id")
  quoteId         String      @map("quote_id")
  cadenceEventId  String?     @map("cadence_event_id")
  
  type            String      // call | follow_up | custom
  title           String
  description     String?
  dueAt           DateTime?   @map("due_at")
  priority        CallPriority @default(LOW)
  status          TaskStatus  @default(pending)
  assignedToId    String?     @map("assigned_to")
  completedAt     DateTime?   @map("completed_at")
  notes           String?

  createdAt       DateTime    @default(now()) @map("created_at")
  updatedAt       DateTime    @updatedAt @map("updated_at")

  // Relations
  organization    Organization  @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  quote           Quote         @relation(fields: [quoteId], references: [id], onDelete: Cascade)
  cadenceEvent    CadenceEvent? @relation(fields: [cadenceEventId], references: [id])
  assignedTo      User?         @relation("AssignedTo", fields: [assignedToId], references: [id])

  @@unique([cadenceEventId]) // Prevent duplicate tasks for same event
  @@index([organizationId, status, dueAt])
  @@map("tasks")
}

// ============================================================================
// EMAIL LOGS
// ============================================================================

model EmailLog {
  id               String         @id @default(uuid())
  organizationId   String         @map("organization_id")
  quoteId          String?        @map("quote_id")
  cadenceEventId   String?        @map("cadence_event_id")
  templateId       String?        @map("template_id")
  
  toEmail          String         @map("to_email")
  subject          String?
  provider         String?        // resend | smtp | manual
  providerMessageId String?       @map("provider_message_id")
  status           EmailLogStatus @default(queued)
  sentAt           DateTime?      @map("sent_at")
  errorMessage     String?        @map("error_message")

  createdAt        DateTime       @default(now()) @map("created_at")

  // Relations
  organization     Organization   @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  quote            Quote?         @relation(fields: [quoteId], references: [id])
  cadenceEvent     CadenceEvent?  @relation(fields: [cadenceEventId], references: [id])
  template         Template?      @relation(fields: [templateId], references: [id])

  @@unique([cadenceEventId]) // Prevent duplicate email sends for same event
  @@index([quoteId, createdAt])
  @@map("email_logs")
}

// ============================================================================
// TEMPLATES
// ============================================================================

model Template {
  id              String   @id @default(uuid())
  organizationId  String   @map("organization_id")
  code            String   // T2 | T3 | T5 | CALL_SCRIPT
  name            String
  subject         String?
  body            String
  variables       Json?    // [{name, default}]
  isActive        Boolean  @default(true) @map("is_active")

  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  // Relations
  organization    Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  emailLogs       EmailLog[]

  @@unique([organizationId, code])
  @@map("templates")
}

// ============================================================================
// SUPPRESSIONS
// ============================================================================

model SuppressionGlobal {
  id              String            @id @default(uuid())
  organizationId  String            @map("organization_id")
  email           String
  reason          SuppressionReason?

  createdAt       DateTime          @default(now()) @map("created_at")

  // Relations
  organization    Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@unique([organizationId, email])
  @@map("suppression_global")
}

// ============================================================================
// BILLING
// ============================================================================

model Plan {
  id                String   @id // free | starter | pro | enterprise
  name              String
  monthlyQuoteLimit Int      @map("monthly_quote_limit")
  priceMonthly      Int      @default(0) @map("price_monthly") // In cents (EUR)
  stripePriceId     String?  @map("stripe_price_id")
  isActive          Boolean  @default(true) @map("is_active")

  createdAt         DateTime @default(now()) @map("created_at")
  updatedAt         DateTime @updatedAt @map("updated_at")

  // Relations
  subscriptions     Subscription[]

  @@map("plans")
}

model StripeEvent {
  id              String   @id @default(uuid())
  stripeEventId   String   @unique @map("stripe_event_id") // Stripe event ID for idempotency
  eventType       String   @map("event_type")
  processedAt     DateTime @default(now()) @map("processed_at")
  payload         Json?    // Store non-PII event data for debugging

  @@map("stripe_events")
}

model Subscription {
  id                    String             @id @default(uuid())
  organizationId        String             @unique @map("organization_id")
  stripeCustomerId      String?            @map("stripe_customer_id")
  stripeSubscriptionId  String?            @unique @map("stripe_subscription_id") // Unique for lookup
  planId                String             @default("free") @map("plan_id")
  status                SubscriptionStatus @default(active)
  quotesLimit           Int                @default(10) @map("quotes_limit")
  currentPeriodStart    DateTime?          @map("current_period_start")
  currentPeriodEnd      DateTime?          @map("current_period_end")
  cancelAtPeriodEnd     Boolean            @default(false) @map("cancel_at_period_end")

  createdAt             DateTime           @default(now()) @map("created_at")
  updatedAt             DateTime           @updatedAt @map("updated_at")

  // Relations
  organization          Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  plan                  Plan         @relation(fields: [planId], references: [id])

  @@map("subscriptions")
}

model UsageCounter {
  id              String   @id @default(uuid())
  organizationId  String   @map("organization_id")
  periodStart     DateTime @map("period_start")
  periodEnd       DateTime @map("period_end")
  quotesSent      Int      @default(0) @map("quotes_sent")   // Counts first_sent_at, not resends
  emailsSent      Int      @default(0) @map("emails_sent")

  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  // Relations
  organization    Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@unique([organizationId, periodStart])
  @@map("usage_counters")
}

// ============================================================================
// ATTACHMENTS & INBOUND
// ============================================================================

model Attachment {
  id              String   @id @default(uuid())
  organizationId  String   @map("organization_id")
  filename        String
  contentType     String?  @map("content_type")
  sizeBytes       BigInt?  @map("size_bytes")
  storagePath     String   @map("storage_path")
  uploadedById    String?  @map("uploaded_by")

  createdAt       DateTime @default(now()) @map("created_at")

  // Relations
  organization    Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  uploadedBy      User?        @relation("UploadedBy", fields: [uploadedById], references: [id])
  quotesAsProposal Quote[]     @relation("ProposalFile")
  inboundIngestions InboundIngestion[]

  @@map("attachments")
}

model InboundIngestion {
  id              String       @id @default(uuid())
  organizationId  String?      @map("organization_id")
  quoteId         String?      @map("quote_id")

  // Provider info (Mailgun)
  provider        String       @default("mailgun") // mailgun | sendgrid
  providerMessageId String?    @unique @map("provider_message_id") // For idempotency
  bodyChecksum    String?      @map("body_checksum") // SHA256 of body for dedupe

  // Raw email data
  rawFrom         String?      @map("raw_from")
  rawTo           String?      @map("raw_to")
  rawSubject      String?      @map("raw_subject")
  rawBodyText     String?      @map("raw_body_text") @db.Text
  rawBodyHtml     String?      @map("raw_body_html") @db.Text

  // Parsed results
  parsedLink      String?      @map("parsed_link")
  attachmentId    String?      @map("attachment_id")

  // Processing state
  status          IngestStatus @default(pending)
  errorMessage    String?      @map("error_message")
  processedAt     DateTime?    @map("processed_at")
  receivedAt      DateTime     @default(now()) @map("received_at")

  createdAt       DateTime     @default(now()) @map("created_at")

  // Relations
  organization    Organization? @relation(fields: [organizationId], references: [id])
  quote           Quote?        @relation(fields: [quoteId], references: [id])
  attachment      Attachment?   @relation(fields: [attachmentId], references: [id])

  @@index([providerMessageId])
  @@index([bodyChecksum])
  @@map("inbound_ingestions")
}

// ============================================================================
// FEEDBACK
// ============================================================================

model FeedbackItem {
  id              String   @id @default(uuid())
  organizationId  String?  @map("organization_id")
  userId          String?  @map("user_id")

  type            String   // bug | feature | other
  message         String   @db.Text
  page            String?  // Current page path when submitted
  userAgent       String?  @map("user_agent")

  status          String   @default("new") // new | reviewed | resolved

  createdAt       DateTime @default(now()) @map("created_at")

  @@index([organizationId, createdAt])
  @@map("feedback_items")
}
